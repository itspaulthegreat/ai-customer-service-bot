export const submitRating = webMethod(Permissions.SiteMember, async (ratingData) => {
    try {
        const { userId, orderId, productId, rating } = ratingData;

        // Validate inputs
        if (!userId || !orderId || !productId) {
            throw new Error("Missing required fields: userId, orderId, or productId.");
        }

        if (typeof rating !== "number" || rating < CONSTANTS.REVIEWS.RATING_MIN || rating > CONSTANTS.REVIEWS.RATING_MAX) {
            throw new Error(CONSTANTS.ERROR_MESSAGES.REVIEW_INVALID_RATING);
        }
        console.log("all data for rating submite",orderId,userId)
        // Validate order
        const orderResult = await wixData.query("Orders")
            .eq("_id", orderId)
            .eq("userId", userId)
            .eq("status", "Paid")
            .find();
    console.log("total order",orderResult)
        if (orderResult.items.length === 0) {
            throw new Error(CONSTANTS.ERROR_MESSAGES.REVIEW_NO_ORDER);
        }

        const order = orderResult.items[0];
        const hasProduct = order.products.some(item => item.catalogItemId === productId);
        if (!hasProduct) {
            throw new Error(CONSTANTS.ERROR_MESSAGES.REVIEW_NO_ORDER);
        }

        // Check shipment status
        const orderItemResult = await wixData.query(CONSTANTS.COLLECTIONS.ORDER_ITEMS)
            .eq("orderId", orderId)
            .eq("catalogItemId", productId)
            .eq("shipmentStatus", "Delivered")
            .find();

        if (orderItemResult.items.length === 0) {
            throw new Error(CONSTANTS.ERROR_MESSAGES.REVIEW_NOT_DELIVERED);
        }

        // Find existing review
        const existingReview = await wixData.query(CONSTANTS.COLLECTIONS.REVIEWS)
            .eq("orderId", orderId)
            .eq("productId", productId)
            .find();

        let review;
        if (existingReview.items.length > 0) {
            review = existingReview.items[0];
            review.rating = rating;
            // Otherwise, keep existing status (allows update without changing pending/rejected/approved)
            await wixData.update(CONSTANTS.COLLECTIONS.REVIEWS, review);
        } else {
            review = {
                userId,
                orderId,
                productId,
                reviewText: "",
                imageUrl: "",
                status: CONSTANTS.REVIEWS.STATUSES.APPROVED,
                customerName: "Anonymous"
            };
            await wixData.insert(CONSTANTS.COLLECTIONS.REVIEWS, review);
        }

        return { success: true, message: "Rating submitted successfully." };
    } catch (error) {
        console.error("Error submitting rating:", error);
        return { success: false, message: error.message };
    }
});